<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="./style.css">
    <title>Kindle Dashboard</title>
</head>
<body>
    <!-- Error Banner -->
    <div class="error-banner" id="error-banner">
        <div class="error-banner-title">⚠ Error Occurred</div>
        <div class="error-banner-message" id="error-message"></div>
    </div>

    <div class="dashboard-container">
        <!-- Dashboards will be inserted here dynamically -->
        <div id="dashboards-wrapper"></div>

        <!-- Page indicators -->
        <div class="indicators" id="indicators"></div>

        <!-- App drawer button -->
        <button class="drawer-button" id="drawer-button" aria-label="Open apps">Apps</button>
    </div>

    <!-- App Drawer -->
    <div class="app-drawer" id="app-drawer">
        <div class="drawer-header">
            <h2>Apps</h2>
            <button class="close-drawer" id="close-drawer">×</button>
        </div>
        <div class="drawer-apps" id="drawer-apps">
            <!-- Apps will be inserted here -->
        </div>
    </div>

    <script src="./settings.js"></script>
    <script src="./icons.js"></script>
    <script>
        // Error deduplication tracking
        let lastErrorMessage = '';
        let lastErrorTime = 0;
        const ERROR_THROTTLE_MS = 5000; // Don't show same error within 5 seconds

        // Error reporting
        function showError(message, error) {
            console.error('Dashboard Error:', message, error);
            
            // Dedupe/throttle errors
            const errorKey = message + (error ? error.toString() : '');
            const now = Date.now();
            if (errorKey === lastErrorMessage && (now - lastErrorTime) < ERROR_THROTTLE_MS) {
                return; // Skip duplicate error
            }
            lastErrorMessage = errorKey;
            lastErrorTime = now;
            
            const banner = document.getElementById('error-banner');
            const messageEl = document.getElementById('error-message');
            if (banner && messageEl) {
                messageEl.textContent = message + (error ? ': ' + error.message : '');
                banner.classList.add('visible');
            }
        }

        // Dismiss error banner on click
        document.addEventListener('DOMContentLoaded', () => {
            const banner = document.getElementById('error-banner');
            if (banner) {
                banner.addEventListener('click', () => {
                    banner.classList.remove('visible');
                });
                banner.style.cursor = 'pointer';
            }
        });

        // Global error handlers
        window.addEventListener('error', (event) => {
            showError('Unexpected error', event.error || new Error(event.message));
        });

        window.addEventListener('unhandledrejection', (event) => {
            // Safely stringify the rejection reason
            let errorMsg = 'Unknown error';
            try {
                if (event.reason instanceof Error) {
                    errorMsg = event.reason.message;
                } else if (typeof event.reason === 'string') {
                    errorMsg = event.reason;
                } else if (event.reason && typeof event.reason === 'object') {
                    errorMsg = JSON.stringify(event.reason);
                } else {
                    errorMsg = String(event.reason);
                }
            } catch (e) {
                errorMsg = 'Error stringifying rejection reason';
            }
            
            // Only show banner for critical errors, not benign network failures
            const isBenign = errorMsg.includes('fetch') || 
                           errorMsg.includes('network') || 
                           errorMsg.includes('CORS') ||
                           errorMsg.includes('Point fetch failed') ||
                           errorMsg.includes('Forecast fetch failed') ||
                           errorMsg.includes('Alerts fetch failed');
            
            if (!isBenign) {
                showError('Unhandled promise rejection', { message: errorMsg });
            }
        });

        // Safe icon creation with fallback
        function safeCreateIcon(category, name, className = '') {
            try {
                if (typeof createIcon === 'function') {
                    return createIcon(category, name, className);
                }
            } catch (e) {
                console.warn('Icon creation failed:', e);
            }
            // Fallback: return empty div
            const fallback = document.createElement('div');
            fallback.className = `icon ${className}`;
            fallback.textContent = '•';
            return fallback;
        }

        // Safe weather icon getter with fallback
        function safeGetWeatherIcon(condition) {
            try {
                if (typeof getWeatherIcon === 'function') {
                    return getWeatherIcon(condition);
                }
            } catch (e) {
                console.warn('Weather icon creation failed:', e);
            }
            // Fallback: return simple text
            const fallback = document.createElement('div');
            fallback.className = 'weather-icon';
            fallback.textContent = '○';
            return fallback;
        }

        // Dashboard state
        let currentDashboard = 0;
        let totalDashboards = 0;
        let touchStartX = 0;
        let touchEndX = 0;
        let touchStartY = 0;
        let touchEndY = 0;

        // Available panels
        const panelTemplates = {
            'dashboard-main': {
                title: 'Home',
                render: () => `
                    <div class="dashboard-content">
                        <div class="time-display">
                            <div id="clock" class="clock">--:--</div>
                            <div id="date" class="date">Loading...</div>
                        </div>
                        <div class="weather-display">
                            <div id="weather-icon" class="weather-icon"></div>
                            <div id="temperature" class="temperature">--°</div>
                            <div id="conditions" class="conditions">Loading weather...</div>
                        </div>
                    </div>
                    <div class="nav-hint">← Swipe to navigate →</div>
                `
            },
            'dashboard-weather': {
                title: 'Weather Forecast',
                render: () => `
                    <div class="dashboard-content">
                        <h2 class="dashboard-title">Weather Forecast</h2>
                        <div id="weather-alerts" class="weather-alerts"></div>
                        <div id="forecast" class="forecast-list">
                            <div class="loading">Loading forecast...</div>
                        </div>
                    </div>
                    <div class="nav-hint">← Swipe to navigate →</div>
                `
            },
            'dashboard-calendar': {
                title: 'Calendar',
                render: () => `
                    <div class="dashboard-content">
                        <h2 class="dashboard-title">Calendar</h2>
                        <div id="calendar" class="calendar-view">
                            <div class="calendar-header">
                                <span id="month-year"></span>
                            </div>
                            <div class="calendar-grid" id="calendar-grid"></div>
                        </div>
                    </div>
                    <div class="nav-hint">← Swipe to navigate →</div>
                `
            }
        };

        // App list for drawer
        const apps = [
            { name: 'Notes', desc: 'Multiple notes with CRUD', url: './apps/notes/index.html', icon: 'notes' },
            { name: 'Tasks', desc: 'To-do list manager', url: './apps/tasks/index.html', icon: 'tasks' },
            { name: 'Timer', desc: 'Multiple countdown timers', url: './apps/timer/index.html', icon: 'timer' },
            { name: 'Calculator', desc: 'Calculator + unit converter', url: './apps/calculator/index.html', icon: 'calculator' },
            { name: 'RSS Reader', desc: 'Follow RSS/Atom feeds', url: './apps/rss/index.html', icon: 'notes' },
            { name: 'Breathing', desc: 'Breathing exercises', url: './apps/breathing/index.html', icon: 'weather' },
            { name: 'Contacts', desc: 'Local contact book', url: './apps/contacts/index.html', icon: 'tasks' },
            { name: 'Reading Log', desc: 'Track your reading', url: './apps/reading-log/index.html', icon: 'notes' },
            { name: 'Settings', desc: 'Configure dashboard', url: './apps/settings/index.html', icon: 'settings' }
        ];

        // Initialize dashboards
        function initDashboards() {
            const wrapper = document.getElementById('dashboards-wrapper');
            const indicators = document.getElementById('indicators');
            wrapper.innerHTML = '';
            indicators.innerHTML = '';

            const enabledPanels = settingsManager.getEnabledPanels();
            totalDashboards = enabledPanels.length;

            enabledPanels.forEach((panel, index) => {
                // Create dashboard
                const dashboard = document.createElement('div');
                dashboard.className = 'dashboard' + (index === 0 ? ' active' : '');
                dashboard.id = panel.id;
                dashboard.innerHTML = panelTemplates[panel.id].render();
                wrapper.appendChild(dashboard);

                // Create indicator
                const indicator = document.createElement('span');
                indicator.className = 'indicator' + (index === 0 ? ' active' : '');
                indicator.dataset.index = index;
                
                // Use home icon for home panel, dot for others
                if (panel.type === 'home') {
                    const homeIcon = safeCreateIcon('ui', 'home', 'indicator-icon');
                    indicator.appendChild(homeIcon);
                } else {
                    // Just use the default dot styling
                }
                
                indicator.addEventListener('click', () => showDashboard(index));
                indicators.appendChild(indicator);
            });

            // Initialize specific dashboards
            updateTime();
            fetchWeather();
            generateCalendar();
        }

        // Initialize app drawer
        function initAppDrawer() {
            const drawerApps = document.getElementById('drawer-apps');
            drawerApps.innerHTML = '';

            apps.forEach(app => {
                const appLink = document.createElement('a');
                appLink.href = app.url;
                appLink.className = 'drawer-app-item';
                
                const iconDiv = document.createElement('div');
                iconDiv.className = 'drawer-app-icon';
                const icon = safeCreateIcon('ui', app.icon);
                iconDiv.appendChild(icon);
                
                const infoDiv = document.createElement('div');
                infoDiv.innerHTML = `
                    <div class="drawer-app-name">${app.name}</div>
                    <div class="drawer-app-desc">${app.desc}</div>
                `;
                
                appLink.appendChild(iconDiv);
                appLink.appendChild(infoDiv);
                drawerApps.appendChild(appLink);
            });
        }

        // Update clock and date
        function updateTime() {
            const now = new Date();
            const clockEl = document.getElementById('clock');
            if (!clockEl) return;

            const timeFormat = settingsManager.getSetting('timeFormat');
            let hours = now.getHours();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            if (timeFormat === '12hr') {
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12; // 0 should be 12
                clockEl.textContent = hours + ':' + minutes + ' ' + ampm;
            } else {
                clockEl.textContent = String(hours).padStart(2, '0') + ':' + minutes;
            }
            
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateEl = document.getElementById('date');
            if (dateEl) {
                dateEl.textContent = now.toLocaleDateString('en-US', options);
            }
        }

        // Fetch weather alerts
        async function fetchWeatherAlerts(zoneId) {
            const alertsEl = document.getElementById('weather-alerts');
            if (!alertsEl) return;

            try {
                const location = settingsManager.getSetting('weatherLocation');
                const lat = location.lat;
                const lon = location.lon;
                
                // Use point-based alerts if zone not available
                const alertsUrl = `https://api.weather.gov/alerts/active?point=${lat},${lon}`;
                const response = await fetch(alertsUrl);
                
                if (!response.ok) throw new Error('Alerts fetch failed');
                
                const data = await response.json();
                const alerts = data.features || [];
                
                // Filter for severe weather
                const severeAlerts = alerts.filter(alert => {
                    const severity = alert.properties.severity;
                    return severity === 'Severe' || severity === 'Extreme';
                });
                
                if (severeAlerts.length === 0) {
                    alertsEl.innerHTML = '';
                    return;
                }
                
                // Display alerts
                alertsEl.innerHTML = '';
                severeAlerts.forEach(alert => {
                    const props = alert.properties;
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'weather-alert';
                    alertDiv.innerHTML = `
                        <div class="alert-header">
                            <span class="alert-severity">${props.severity}</span>
                            <span class="alert-event">${props.event}</span>
                        </div>
                        <div class="alert-headline">${props.headline || props.description}</div>
                    `;
                    alertsEl.appendChild(alertDiv);
                });
            } catch (error) {
                console.error('Alerts fetch error:', error);
                if (alertsEl) alertsEl.innerHTML = '';
            }
        }

        // Fetch weather from weather.gov API
        async function fetchWeather() {
            try {
                const location = settingsManager.getSetting('weatherLocation');
                const lat = location.lat;
                const lon = location.lon;
                
                // Get point data
                const pointResponse = await fetch(`https://api.weather.gov/points/${lat},${lon}`);
                if (!pointResponse.ok) throw new Error('Point fetch failed');
                const pointData = await pointResponse.json();
                
                // Fetch weather alerts
                fetchWeatherAlerts(pointData.properties.zone || null);
                
                // Get forecast
                const forecastResponse = await fetch(pointData.properties.forecast);
                if (!forecastResponse.ok) throw new Error('Forecast fetch failed');
                const forecastData = await forecastResponse.json();
                
                // Current conditions (first period)
                const current = forecastData.properties.periods[0];
                const tempEl = document.getElementById('temperature');
                const conditionsEl = document.getElementById('conditions');
                const weatherIconEl = document.getElementById('weather-icon');
                
                if (tempEl) tempEl.textContent = current.temperature + '°' + current.temperatureUnit;
                if (conditionsEl) conditionsEl.textContent = current.shortForecast;
                if (weatherIconEl) {
                    weatherIconEl.innerHTML = '';
                    const icon = safeGetWeatherIcon(current.shortForecast);
                    weatherIconEl.appendChild(icon);
                }
                
                // Forecast list
                const forecastList = document.getElementById('forecast');
                if (forecastList) {
                    forecastList.innerHTML = '';
                    forecastData.properties.periods.slice(0, 5).forEach(period => {
                        const item = document.createElement('div');
                        item.className = 'forecast-item';
                        
                        const iconDiv = document.createElement('div');
                        iconDiv.className = 'forecast-icon';
                        const icon = safeGetWeatherIcon(period.shortForecast);
                        iconDiv.appendChild(icon);
                        
                        item.innerHTML = `
                            <div class="forecast-time">${period.name}</div>
                        `;
                        item.appendChild(iconDiv);
                        item.innerHTML += `
                            <div class="forecast-temp">${period.temperature}°${period.temperatureUnit}</div>
                            <div class="forecast-desc">${period.shortForecast}</div>
                        `;
                        forecastList.appendChild(item);
                    });
                }
            } catch (error) {
                console.error('Weather fetch error:', error);
                const tempEl = document.getElementById('temperature');
                const conditionsEl = document.getElementById('conditions');
                const weatherIconEl = document.getElementById('weather-icon');
                const forecastList = document.getElementById('forecast');
                
                if (tempEl) tempEl.textContent = 'N/A';
                if (conditionsEl) conditionsEl.textContent = 'Weather unavailable';
                if (weatherIconEl) weatherIconEl.textContent = '○';
                if (forecastList) {
                    forecastList.innerHTML = '<div class="error">Unable to load forecast. Check location in settings.</div>';
                }
            }
        }

        // Generate calendar
        function generateCalendar() {
            const grid = document.getElementById('calendar-grid');
            if (!grid) return;

            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            
            const monthYearEl = document.getElementById('month-year');
            if (monthYearEl) {
                monthYearEl.textContent = new Date(year, month, 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            }
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = now.getDate();
            
            grid.innerHTML = '';
            
            // Day headers
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'calendar-day empty';
                grid.appendChild(empty);
            }
            
            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                if (day === today) {
                    dayCell.classList.add('today');
                }
                dayCell.textContent = day;
                grid.appendChild(dayCell);
            }
        }

        // Dashboard navigation
        function showDashboard(index) {
            if (index < 0) index = 0;
            if (index >= totalDashboards) index = totalDashboards - 1;
            
            document.querySelectorAll('.dashboard').forEach((dash, i) => {
                dash.classList.toggle('active', i === index);
            });
            
            document.querySelectorAll('.indicator').forEach((ind, i) => {
                ind.classList.toggle('active', i === index);
            });
            
            currentDashboard = index;
            
            // Show/hide drawer button based on current dashboard
            const drawerButton = document.getElementById('drawer-button');
            if (drawerButton) {
                if (index === 0) {
                    drawerButton.style.display = 'block';
                } else {
                    drawerButton.style.display = 'none';
                }
            }
        }

        // App drawer controls
        function openDrawer() {
            document.getElementById('app-drawer').classList.add('open');
        }

        function closeDrawer() {
            document.getElementById('app-drawer').classList.remove('open');
        }

        // Touch/swipe handling
        function handleTouchStart(e) {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }

        function handleTouchEnd(e) {
            touchEndX = e.changedTouches[0].screenX;
            touchEndY = e.changedTouches[0].screenY;
            handleSwipe();
        }

        function handleSwipe() {
            const swipeThreshold = 50;
            const diffX = touchStartX - touchEndX;
            const diffY = touchStartY - touchEndY;
            
            // Check if it's primarily a vertical swipe
            if (Math.abs(diffY) > Math.abs(diffX) && Math.abs(diffY) > swipeThreshold) {
                if (diffY > 0) {
                    // Swipe up - open drawer only on main screen
                    if (currentDashboard === 0) {
                        openDrawer();
                    }
                }
                return;
            }
            
            // Horizontal swipe for panel navigation
            if (Math.abs(diffX) > swipeThreshold) {
                if (diffX > 0) {
                    // Swipe left - next dashboard
                    showDashboard(currentDashboard + 1);
                } else {
                    // Swipe right - previous dashboard
                    showDashboard(currentDashboard - 1);
                }
            }
        }

        // Keyboard navigation
        function handleKeyboard(e) {
            if (e.key === 'ArrowLeft') {
                showDashboard(currentDashboard - 1);
            } else if (e.key === 'ArrowRight') {
                showDashboard(currentDashboard + 1);
            } else if (e.key === 'ArrowUp') {
                // Only open drawer on main screen
                if (currentDashboard === 0) {
                    openDrawer();
                }
            } else if (e.key === 'Escape') {
                closeDrawer();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Verify settingsManager is available
                if (typeof settingsManager === 'undefined' || !settingsManager) {
                    throw new Error('SettingsManager not initialized');
                }

                // Apply theme
                settingsManager.applyTheme();
                
                // Initialize dashboards and drawer
                initDashboards();
                initAppDrawer();
                
                // Update time every minute
                setInterval(updateTime, 60000);
                
                // Update weather every 30 minutes
                setInterval(fetchWeather, 1800000);
                
                // Update theme hourly (for time-based dark mode)
                setInterval(() => settingsManager.applyTheme(), 3600000);
                
                // Event listeners for drawer
                document.getElementById('close-drawer').addEventListener('click', closeDrawer);
                document.getElementById('drawer-button').addEventListener('click', openDrawer);
                
                // Event listeners for touch/keyboard navigation
                document.addEventListener('touchstart', handleTouchStart);
                document.addEventListener('touchend', handleTouchEnd);
                document.addEventListener('keydown', handleKeyboard);
                
                // Close drawer when clicking backdrop
                document.getElementById('app-drawer').addEventListener('click', (e) => {
                    if (e.target.id === 'app-drawer') {
                        closeDrawer();
                    }
                });
            } catch (error) {
                showError('Failed to initialize dashboard', error);
            }
        });
    </script>
</body>
</html>
