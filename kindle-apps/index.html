<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="./style.css">
    <title>Kindle Dashboard</title>
</head>
<body>
    <div class="dashboard-container">
        <!-- Dashboards will be inserted here dynamically -->
        <div id="dashboards-wrapper"></div>

        <!-- Page indicators -->
        <div class="indicators" id="indicators"></div>

        <!-- App drawer button -->
        <button class="drawer-button" id="drawer-button" aria-label="Open apps">Apps</button>
    </div>

    <!-- App Drawer -->
    <div class="app-drawer" id="app-drawer">
        <div class="drawer-header">
            <h2>Apps</h2>
            <button class="close-drawer" id="close-drawer">×</button>
        </div>
        <div class="drawer-apps" id="drawer-apps">
            <!-- Apps will be inserted here -->
        </div>
    </div>

    <script src="./settings.js"></script>
    <script src="./icons.js"></script>
    <script>
        // Dashboard state
        let currentDashboard = 0;
        let totalDashboards = 0;
        let touchStartX = 0;
        let touchEndX = 0;
        let touchStartY = 0;
        let touchEndY = 0;

        // Available panels
        const panelTemplates = {
            'dashboard-main': {
                title: 'Home',
                render: () => `
                    <div class="dashboard-content">
                        <div class="time-display">
                            <div id="clock" class="clock">--:--</div>
                            <div id="date" class="date">Loading...</div>
                        </div>
                        <div class="weather-display">
                            <div id="weather-icon" class="weather-icon"></div>
                            <div id="temperature" class="temperature">--°</div>
                            <div id="conditions" class="conditions">Loading weather...</div>
                        </div>
                    </div>
                    <div class="nav-hint">← Swipe to navigate →</div>
                `
            },
            'dashboard-weather': {
                title: 'Weather Forecast',
                render: () => `
                    <div class="dashboard-content">
                        <h2 class="dashboard-title">Weather Forecast</h2>
                        <div id="forecast" class="forecast-list">
                            <div class="loading">Loading forecast...</div>
                        </div>
                    </div>
                    <div class="nav-hint">← Swipe to navigate →</div>
                `
            },
            'dashboard-calendar': {
                title: 'Calendar',
                render: () => `
                    <div class="dashboard-content">
                        <h2 class="dashboard-title">Calendar</h2>
                        <div id="calendar" class="calendar-view">
                            <div class="calendar-header">
                                <span id="month-year"></span>
                            </div>
                            <div class="calendar-grid" id="calendar-grid"></div>
                        </div>
                    </div>
                    <div class="nav-hint">← Swipe to navigate →</div>
                `
            }
        };

        // App list for drawer
        const apps = [
            { name: 'Notes', desc: 'Simple notepad with save', url: './apps/notes/index.html', icon: 'notes' },
            { name: 'Tasks', desc: 'To-do list manager', url: './apps/tasks/index.html', icon: 'tasks' },
            { name: 'Timer', desc: 'Countdown timer', url: './apps/timer/index.html', icon: 'timer' },
            { name: 'Calculator', desc: 'Basic calculator', url: './apps/calculator/index.html', icon: 'calculator' },
            { name: 'Settings', desc: 'Configure dashboard', url: './apps/settings/index.html', icon: 'settings' }
        ];

        // Initialize dashboards
        function initDashboards() {
            const wrapper = document.getElementById('dashboards-wrapper');
            const indicators = document.getElementById('indicators');
            wrapper.innerHTML = '';
            indicators.innerHTML = '';

            const enabledPanels = settingsManager.getEnabledPanels();
            totalDashboards = enabledPanels.length;

            enabledPanels.forEach((panel, index) => {
                // Create dashboard
                const dashboard = document.createElement('div');
                dashboard.className = 'dashboard' + (index === 0 ? ' active' : '');
                dashboard.id = panel.id;
                dashboard.innerHTML = panelTemplates[panel.id].render();
                wrapper.appendChild(dashboard);

                // Create indicator
                const indicator = document.createElement('span');
                indicator.className = 'indicator' + (index === 0 ? ' active' : '');
                indicator.dataset.index = index;
                
                // Use home icon for home panel, dot for others
                if (panel.type === 'home') {
                    const homeIcon = createIcon('ui', 'home', 'indicator-icon');
                    indicator.appendChild(homeIcon);
                } else {
                    // Just use the default dot styling
                }
                
                indicator.addEventListener('click', () => showDashboard(index));
                indicators.appendChild(indicator);
            });

            // Initialize specific dashboards
            updateTime();
            fetchWeather();
            generateCalendar();
        }

        // Initialize app drawer
        function initAppDrawer() {
            const drawerApps = document.getElementById('drawer-apps');
            drawerApps.innerHTML = '';

            apps.forEach(app => {
                const appLink = document.createElement('a');
                appLink.href = app.url;
                appLink.className = 'drawer-app-item';
                
                const iconDiv = document.createElement('div');
                iconDiv.className = 'drawer-app-icon';
                const icon = createIcon('ui', app.icon);
                iconDiv.appendChild(icon);
                
                const infoDiv = document.createElement('div');
                infoDiv.innerHTML = `
                    <div class="drawer-app-name">${app.name}</div>
                    <div class="drawer-app-desc">${app.desc}</div>
                `;
                
                appLink.appendChild(iconDiv);
                appLink.appendChild(infoDiv);
                drawerApps.appendChild(appLink);
            });
        }

        // Update clock and date
        function updateTime() {
            const now = new Date();
            const clockEl = document.getElementById('clock');
            if (!clockEl) return;

            const timeFormat = settingsManager.getSetting('timeFormat');
            let hours = now.getHours();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            if (timeFormat === '12hr') {
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12; // 0 should be 12
                clockEl.textContent = hours + ':' + minutes + ' ' + ampm;
            } else {
                clockEl.textContent = String(hours).padStart(2, '0') + ':' + minutes;
            }
            
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateEl = document.getElementById('date');
            if (dateEl) {
                dateEl.textContent = now.toLocaleDateString('en-US', options);
            }
        }

        // Fetch weather from weather.gov API
        async function fetchWeather() {
            try {
                const location = settingsManager.getSetting('weatherLocation');
                const lat = location.lat;
                const lon = location.lon;
                
                // Get point data
                const pointResponse = await fetch(`https://api.weather.gov/points/${lat},${lon}`);
                if (!pointResponse.ok) throw new Error('Point fetch failed');
                const pointData = await pointResponse.json();
                
                // Get forecast
                const forecastResponse = await fetch(pointData.properties.forecast);
                if (!forecastResponse.ok) throw new Error('Forecast fetch failed');
                const forecastData = await forecastResponse.json();
                
                // Current conditions (first period)
                const current = forecastData.properties.periods[0];
                const tempEl = document.getElementById('temperature');
                const conditionsEl = document.getElementById('conditions');
                const weatherIconEl = document.getElementById('weather-icon');
                
                if (tempEl) tempEl.textContent = current.temperature + '°' + current.temperatureUnit;
                if (conditionsEl) conditionsEl.textContent = current.shortForecast;
                if (weatherIconEl) {
                    weatherIconEl.innerHTML = '';
                    const icon = getWeatherIcon(current.shortForecast);
                    weatherIconEl.appendChild(icon);
                }
                
                // Forecast list
                const forecastList = document.getElementById('forecast');
                if (forecastList) {
                    forecastList.innerHTML = '';
                    forecastData.properties.periods.slice(0, 7).forEach(period => {
                        const item = document.createElement('div');
                        item.className = 'forecast-item';
                        
                        const iconDiv = document.createElement('div');
                        iconDiv.className = 'forecast-icon';
                        const icon = getWeatherIcon(period.shortForecast);
                        iconDiv.appendChild(icon);
                        
                        item.innerHTML = `
                            <div class="forecast-time">${period.name}</div>
                        `;
                        item.appendChild(iconDiv);
                        item.innerHTML += `
                            <div class="forecast-temp">${period.temperature}°${period.temperatureUnit}</div>
                            <div class="forecast-desc">${period.shortForecast}</div>
                        `;
                        forecastList.appendChild(item);
                    });
                }
            } catch (error) {
                console.error('Weather fetch error:', error);
                const tempEl = document.getElementById('temperature');
                const conditionsEl = document.getElementById('conditions');
                const weatherIconEl = document.getElementById('weather-icon');
                const forecastList = document.getElementById('forecast');
                
                if (tempEl) tempEl.textContent = 'N/A';
                if (conditionsEl) conditionsEl.textContent = 'Weather unavailable';
                if (weatherIconEl) weatherIconEl.textContent = '○';
                if (forecastList) {
                    forecastList.innerHTML = '<div class="error">Unable to load forecast. Check location in settings.</div>';
                }
            }
        }

        // Generate calendar
        function generateCalendar() {
            const grid = document.getElementById('calendar-grid');
            if (!grid) return;

            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            
            const monthYearEl = document.getElementById('month-year');
            if (monthYearEl) {
                monthYearEl.textContent = new Date(year, month, 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            }
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = now.getDate();
            
            grid.innerHTML = '';
            
            // Day headers
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'calendar-day empty';
                grid.appendChild(empty);
            }
            
            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                if (day === today) {
                    dayCell.classList.add('today');
                }
                dayCell.textContent = day;
                grid.appendChild(dayCell);
            }
        }

        // Dashboard navigation
        function showDashboard(index) {
            if (index < 0) index = 0;
            if (index >= totalDashboards) index = totalDashboards - 1;
            
            document.querySelectorAll('.dashboard').forEach((dash, i) => {
                dash.classList.toggle('active', i === index);
            });
            
            document.querySelectorAll('.indicator').forEach((ind, i) => {
                ind.classList.toggle('active', i === index);
            });
            
            currentDashboard = index;
        }

        // App drawer controls
        function openDrawer() {
            document.getElementById('app-drawer').classList.add('open');
        }

        function closeDrawer() {
            document.getElementById('app-drawer').classList.remove('open');
        }

        document.getElementById('close-drawer').addEventListener('click', closeDrawer);
        document.getElementById('drawer-button').addEventListener('click', openDrawer);

        // Touch/swipe handling
        function handleTouchStart(e) {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }

        function handleTouchEnd(e) {
            touchEndX = e.changedTouches[0].screenX;
            touchEndY = e.changedTouches[0].screenY;
            handleSwipe();
        }

        function handleSwipe() {
            const swipeThreshold = 50;
            const diffX = touchStartX - touchEndX;
            const diffY = touchStartY - touchEndY;
            
            // Check if it's primarily a vertical swipe
            if (Math.abs(diffY) > Math.abs(diffX) && Math.abs(diffY) > swipeThreshold) {
                if (diffY > 0) {
                    // Swipe up - open drawer
                    openDrawer();
                }
                return;
            }
            
            // Horizontal swipe for panel navigation
            if (Math.abs(diffX) > swipeThreshold) {
                if (diffX > 0) {
                    // Swipe left - next dashboard
                    showDashboard(currentDashboard + 1);
                } else {
                    // Swipe right - previous dashboard
                    showDashboard(currentDashboard - 1);
                }
            }
        }

        // Keyboard navigation
        function handleKeyboard(e) {
            if (e.key === 'ArrowLeft') {
                showDashboard(currentDashboard - 1);
            } else if (e.key === 'ArrowRight') {
                showDashboard(currentDashboard + 1);
            } else if (e.key === 'ArrowUp') {
                openDrawer();
            } else if (e.key === 'Escape') {
                closeDrawer();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Apply theme
            settingsManager.applyTheme();
            
            // Initialize dashboards and drawer
            initDashboards();
            initAppDrawer();
            
            // Update time every minute
            setInterval(updateTime, 60000);
            
            // Update weather every 30 minutes
            setInterval(fetchWeather, 1800000);
            
            // Update theme hourly (for time-based dark mode)
            setInterval(() => settingsManager.applyTheme(), 3600000);
            
            // Event listeners
            document.addEventListener('touchstart', handleTouchStart);
            document.addEventListener('touchend', handleTouchEnd);
            document.addEventListener('keydown', handleKeyboard);
            
            // Close drawer when clicking backdrop
            document.getElementById('app-drawer').addEventListener('click', (e) => {
                if (e.target.id === 'app-drawer') {
                    closeDrawer();
                }
            });
        });
    </script>
</body>
</html>
